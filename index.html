<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pro Mobile Scanner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        /* Mobile-first resets */
        body {
            background-color: #111827; /* Dark mode base */
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            overscroll-behavior-y: none; /* Prevent pull-to-refresh on mobile */
            -webkit-tap-highlight-color: transparent;
        }

        /* The scanner container */
        #reader {
            width: 100%;
            height: 100%;
            background: #000;
            position: relative;
        }
        #reader video {
            object-fit: cover;
            width: 100% !important;
            height: 100% !important;
        }

        /* Hide library junk */
        #reader__dashboard_section_csr span, 
        #reader__dashboard_section_swaplink { display: none !important; }

        /* Animations */
        @keyframes flash-success {
            0% { box-shadow: inset 0 0 0 0 rgba(34, 197, 94, 0); border-color: transparent; }
            50% { box-shadow: inset 0 0 0 50px rgba(34, 197, 94, 0.3); border-color: #22c55e; }
            100% { box-shadow: inset 0 0 0 0 rgba(34, 197, 94, 0); border-color: transparent; }
        }
        .scan-success-anim {
            animation: flash-success 0.4s ease-out;
            border: 4px solid #22c55e;
            box-sizing: border-box;
        }

        /* Cooldown Overlay */
        .cooldown-overlay {
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(2px);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
        }
        .cooldown-active { opacity: 1; }

        /* List Animations */
        .new-item-flash {
            animation: highlight-row 1s ease-out;
        }
        @keyframes highlight-row {
            0% { background-color: rgba(59, 130, 246, 0.2); }
            100% { background-color: transparent; }
        }
    </style>
</head>
<body class="h-[100dvh] flex flex-col text-slate-100 overflow-hidden">

    <!-- 1. Top Bar: Controls & Status -->
    <div class="flex-none bg-slate-900 border-b border-slate-800 p-3 flex justify-between items-center z-20 shadow-md">
        <div class="flex items-center gap-2">
            <div id="status-dot" class="w-3 h-3 rounded-full bg-red-500 shadow-[0_0_8px_rgba(239,68,68,0.5)] transition-colors duration-300"></div>
            <div class="leading-tight">
                <h1 class="font-bold text-sm tracking-wide text-slate-100">INVENTORY PRO</h1>
                <p class="text-[10px] text-slate-400 font-mono" id="camera-name">Camera Off</p>
            </div>
        </div>
        <div class="flex gap-2">
            <button id="btn-manual" class="w-8 h-8 rounded-full bg-slate-800 text-blue-400 border border-slate-700 flex items-center justify-center hover:bg-slate-700 active:scale-95 transition">
                <i class="fa-solid fa-keyboard text-xs"></i>
            </button>
            <button id="btn-torch" class="hidden w-8 h-8 rounded-full bg-slate-800 text-yellow-500 border border-slate-700 flex items-center justify-center hover:bg-slate-700 active:scale-95 transition">
                <i class="fa-solid fa-bolt text-xs"></i>
            </button>
            <button id="btn-toggle" class="px-4 h-8 bg-blue-600 hover:bg-blue-500 text-white text-xs font-bold uppercase rounded-full tracking-wider shadow-lg shadow-blue-900/50 active:scale-95 transition">
                Start
            </button>
        </div>
    </div>

    <!-- 2. Scanner Viewport (Fixed Height) -->
    <div class="flex-none h-[40vh] relative bg-black overflow-hidden group">
        <div id="reader"></div>

        <!-- Start Placeholder -->
        <div id="placeholder-ui" class="absolute inset-0 flex flex-col items-center justify-center text-slate-500 z-10">
            <i class="fa-solid fa-expand text-4xl mb-3 opacity-50"></i>
            <p class="text-xs font-mono uppercase tracking-widest">Scanner Ready</p>
        </div>

        <!-- Cooldown / Processing Overlay -->
        <div id="cooldown-ui" class="cooldown-overlay absolute inset-0 z-20 flex flex-col items-center justify-center text-white">
            <i class="fa-solid fa-check-circle text-5xl text-green-500 mb-2 drop-shadow-lg"></i>
            <span class="text-lg font-bold drop-shadow-md">SAVED</span>
        </div>

        <!-- Zoom Slider Overlay (Bottom of scanner) -->
        <div id="zoom-ui" class="absolute bottom-2 left-4 right-4 z-20 opacity-0 translate-y-4 transition-all duration-300 pointer-events-none">
            <div class="bg-black/60 backdrop-blur-sm rounded-full px-4 py-2 flex items-center gap-3 pointer-events-auto">
                <span class="text-[10px] font-bold">1x</span>
                <input type="range" id="zoom-slider" min="1" max="5" step="0.1" value="1" class="w-full h-1 bg-gray-600 rounded-lg appearance-none cursor-pointer accent-blue-500">
                <span class="text-[10px] font-bold">Max</span>
            </div>
        </div>
    </div>

    <!-- 3. Inventory List Header -->
    <div class="flex-none bg-slate-800 border-b border-slate-700 p-3 shadow-sm z-10 flex justify-between items-center">
        <div class="flex gap-4">
            <div>
                <div class="text-[10px] text-slate-400 uppercase font-bold">Count</div>
                <div id="total-count" class="text-lg font-mono font-bold text-white leading-none">0</div>
            </div>
            <div>
                <div class="text-[10px] text-slate-400 uppercase font-bold">Total Qty</div>
                <div id="total-qty" class="text-lg font-mono font-bold text-blue-400 leading-none">0</div>
            </div>
        </div>
        <div class="flex gap-2">
            <button onclick="downloadCSV()" class="p-2 text-slate-300 hover:text-white transition" title="Download CSV">
                <i class="fa-solid fa-file-csv text-lg"></i>
            </button>
            <button onclick="clearData()" class="p-2 text-red-400 hover:text-red-300 transition" title="Clear All">
                <i class="fa-solid fa-trash-can text-lg"></i>
            </button>
        </div>
    </div>

    <!-- 4. Scrollable List -->
    <div class="flex-1 overflow-y-auto bg-slate-900 pb-20" id="list-container">
        <!-- Empty State -->
        <div id="empty-state" class="flex flex-col items-center justify-center h-48 text-slate-600">
            <i class="fa-solid fa-box-open text-4xl mb-2"></i>
            <p class="text-sm">No items scanned</p>
        </div>
        
        <!-- List Items Container -->
        <div id="inventory-list" class="divide-y divide-slate-800">
            <!-- Items injected here via JS -->
        </div>
    </div>

    <!-- 5. Manual Input Modal (Hidden by default) -->
    <div id="manual-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="bg-slate-800 w-full max-w-sm rounded-xl p-6 shadow-2xl border border-slate-700">
            <h3 class="text-lg font-bold mb-4 text-white">Manual Entry</h3>
            <input type="text" id="manual-code" placeholder="Enter Barcode" class="w-full bg-slate-900 border border-slate-600 rounded-lg p-3 text-white mb-3 focus:outline-none focus:border-blue-500 font-mono">
            <input type="number" id="manual-qty" value="1" placeholder="Qty" class="w-full bg-slate-900 border border-slate-600 rounded-lg p-3 text-white mb-6 focus:outline-none focus:border-blue-500 font-mono">
            <div class="flex gap-3">
                <button id="btn-cancel-manual" class="flex-1 py-3 rounded-lg bg-slate-700 text-slate-300 font-bold">Cancel</button>
                <button id="btn-confirm-manual" class="flex-1 py-3 rounded-lg bg-blue-600 text-white font-bold shadow-lg shadow-blue-900/50">Add Item</button>
            </div>
        </div>
    </div>

    <!-- Sound & Logic -->
    <script>
        // --- Core Audio ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playBeep() {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            
            osc.type = 'sine';
            osc.frequency.setValueAtTime(1200, audioCtx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(600, audioCtx.currentTime + 0.15);
            
            gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.15);
            
            osc.start();
            osc.stop(audioCtx.currentTime + 0.15);
        }

        // --- State Management ---
        const DB_KEY = 'pro_scanner_db_v1';
        let inventory = JSON.parse(localStorage.getItem(DB_KEY)) || {};
        let html5QrCode;
        let isScanning = false;
        let lastScanTime = 0;
        const SCAN_DELAY = 2000;

        // --- DOM Elements ---
        const ui = {
            btnToggle: document.getElementById('btn-toggle'),
            btnTorch: document.getElementById('btn-torch'),
            statusDot: document.getElementById('status-dot'),
            cameraName: document.getElementById('camera-name'),
            placeholder: document.getElementById('placeholder-ui'),
            cooldown: document.getElementById('cooldown-ui'),
            zoomUi: document.getElementById('zoom-ui'),
            zoomSlider: document.getElementById('zoom-slider'),
            list: document.getElementById('inventory-list'),
            emptyState: document.getElementById('empty-state'),
            totalCount: document.getElementById('total-count'),
            totalQty: document.getElementById('total-qty'),
            btnManual: document.getElementById('btn-manual'),
            manualModal: document.getElementById('manual-modal'),
            manualInput: document.getElementById('manual-code'),
            manualQty: document.getElementById('manual-qty'),
            btnCancelManual: document.getElementById('btn-cancel-manual'),
            btnConfirmManual: document.getElementById('btn-confirm-manual')
        };

        // --- Init ---
        renderList();

        // --- Camera Logic ---
        ui.btnToggle.addEventListener('click', async () => {
            if (isScanning) {
                stopCamera();
            } else {
                startCamera();
            }
        });

        async function startCamera() {
            try {
                html5QrCode = new Html5Qrcode("reader");
                const cameras = await Html5Qrcode.getCameras();
                
                if (!cameras || cameras.length === 0) {
                    alert("No cameras found.");
                    return;
                }

                // Prefer back camera (environment)
                const backCam = cameras.find(c => c.label.toLowerCase().includes('back') || c.label.toLowerCase().includes('environment')) || cameras[0];

                ui.btnToggle.innerText = "STOP";
                ui.btnToggle.classList.replace('bg-blue-600', 'bg-red-600');
                ui.btnToggle.classList.replace('hover:bg-blue-500', 'hover:bg-red-500');
                ui.statusDot.classList.replace('bg-red-500', 'bg-green-500');
                ui.statusDot.classList.add('animate-pulse');
                ui.cameraName.innerText = "Active";
                ui.placeholder.classList.add('hidden');

                const config = {
                    fps: 20,
                    qrbox: (viewfinderWidth, viewfinderHeight) => {
                        // Responsive box: 70% of the smaller dimension
                        const minDim = Math.min(viewfinderWidth, viewfinderHeight);
                        const boxSize = Math.floor(minDim * 0.7);
                        return { width: boxSize, height: boxSize/1.5 }; // wide for barcodes
                    },
                    aspectRatio: 1.0
                };

                await html5QrCode.start(
                    backCam.id, 
                    config, 
                    onScanSuccess, 
                    (err) => {} // Ignore failures
                );

                isScanning = true;
                initCameraFeatures();

            } catch (err) {
                console.error(err);
                alert("Camera Access Denied or Error. Check Permissions.");
                stopCamera();
            }
        }

        async function stopCamera() {
            if (html5QrCode && isScanning) {
                await html5QrCode.stop();
                html5QrCode.clear();
            }
            isScanning = false;
            ui.btnToggle.innerText = "START";
            ui.btnToggle.classList.replace('bg-red-600', 'bg-blue-600');
            ui.btnToggle.classList.replace('hover:bg-red-500', 'hover:bg-blue-500');
            ui.statusDot.classList.replace('bg-green-500', 'bg-red-500');
            ui.statusDot.classList.remove('animate-pulse');
            ui.cameraName.innerText = "Camera Off";
            ui.placeholder.classList.remove('hidden');
            ui.zoomUi.classList.remove('opacity-100');
            ui.zoomUi.classList.add('opacity-0');
            ui.btnTorch.classList.add('hidden');
        }

        function initCameraFeatures() {
            // Wait a moment for the video track to be active
            setTimeout(() => {
                const video = document.querySelector("#reader video");
                if(!video || !video.srcObject) return;

                const track = video.srcObject.getVideoTracks()[0];
                const caps = track.getCapabilities();

                // Zoom
                if(caps.zoom) {
                    ui.zoomUi.classList.remove('opacity-0');
                    ui.zoomUi.classList.add('opacity-100');

                    // OPTIMIZATION: Start at 1.3x (30%) zoom.
                    // 1x often has distortion at edges causing scan errors.
                    const desiredMin = 1.3;
                    const deviceMin = caps.zoom.min;
                    const deviceMax = caps.zoom.max;
                    
                    // Ensure the requested 1.3x is within device capabilities
                    const effectiveMin = Math.max(deviceMin, desiredMin);
                    
                    // Configure Slider
                    ui.zoomSlider.min = effectiveMin;
                    ui.zoomSlider.max = deviceMax;
                    ui.zoomSlider.step = caps.zoom.step || 0.1;
                    ui.zoomSlider.value = effectiveMin;

                    // Update UI Label to show new start point
                    const minLabel = ui.zoomUi.querySelector('span');
                    if(minLabel) minLabel.innerText = effectiveMin + "x";
                    
                    // Apply immediately
                    track.applyConstraints({ advanced: [{ zoom: effectiveMin }] })
                        .catch(e => console.log("Zoom not supported directly", e));
                    
                    ui.zoomSlider.oninput = () => {
                        track.applyConstraints({ advanced: [{ zoom: ui.zoomSlider.value }] });
                    };
                }

                // Torch
                if(caps.torch) {
                    ui.btnTorch.classList.remove('hidden');
                    let torchOn = false;
                    ui.btnTorch.onclick = () => {
                        torchOn = !torchOn;
                        track.applyConstraints({ advanced: [{ torch: torchOn }] });
                        ui.btnTorch.classList.toggle('text-yellow-500', !torchOn);
                        ui.btnTorch.classList.toggle('text-white', torchOn);
                        ui.btnTorch.classList.toggle('bg-yellow-500', torchOn);
                    };
                }
            }, 500);
        }

        // --- Scan Logic ---
        function onScanSuccess(decodedText, decodedResult) {
            const now = Date.now();
            if (now - lastScanTime < SCAN_DELAY) return;

            lastScanTime = now;
            
            // 1. Audio/Haptic Feedback
            playBeep();
            if (navigator.vibrate) navigator.vibrate(200);

            // 2. Visual Feedback
            document.getElementById('reader').classList.remove('scan-success-anim');
            void document.getElementById('reader').offsetWidth; // Reflow
            document.getElementById('reader').classList.add('scan-success-anim');
            
            ui.cooldown.classList.add('cooldown-active');
            setTimeout(() => ui.cooldown.classList.remove('cooldown-active'), SCAN_DELAY);

            // 3. Data Logic
            addItem(decodedText, decodedResult?.result?.format?.formatName || 'BARCODE');
        }

        function addItem(code, format, qtyToAdd = 1) {
            if (inventory[code]) {
                inventory[code].qty += qtyToAdd;
                inventory[code].timestamp = Date.now();
            } else {
                inventory[code] = {
                    code: code,
                    format: format,
                    qty: qtyToAdd,
                    timestamp: Date.now()
                };
            }
            saveData();
            renderList();
            
            // Scroll to top of list to see new update
            ui.list.scrollTop = 0;
        }

        function saveData() {
            localStorage.setItem(DB_KEY, JSON.stringify(inventory));
        }

        // --- Rendering ---
        function renderList() {
            const keys = Object.keys(inventory).sort((a,b) => inventory[b].timestamp - inventory[a].timestamp);
            
            if (keys.length === 0) {
                ui.emptyState.classList.remove('hidden');
                ui.list.innerHTML = '';
                ui.totalCount.innerText = '0';
                ui.totalQty.innerText = '0';
                ui.list.appendChild(ui.emptyState);
                return;
            }

            ui.emptyState.classList.add('hidden');
            ui.list.innerHTML = '';

            let tQty = 0;

            keys.forEach(key => {
                const item = inventory[key];
                tQty += item.qty;

                const div = document.createElement('div');
                div.className = 'p-4 flex justify-between items-center bg-slate-900 hover:bg-slate-800 transition-colors border-l-4 border-transparent hover:border-blue-500';
                
                // Highlight if just scanned (within last 2.1 seconds)
                if (Date.now() - item.timestamp < 2100) {
                    div.classList.add('new-item-flash');
                    div.classList.replace('border-transparent', 'border-green-500');
                }

                div.innerHTML = `
                    <div class="overflow-hidden mr-3">
                        <div class="flex items-center gap-2 mb-1">
                            <span class="text-[10px] font-bold bg-slate-700 text-slate-300 px-1.5 py-0.5 rounded">${item.format}</span>
                            <span class="text-[10px] text-slate-500 font-mono">${new Date(item.timestamp).toLocaleTimeString()}</span>
                        </div>
                        <div class="font-mono text-white text-lg font-medium truncate select-all">${item.code}</div>
                    </div>
                    <div class="flex items-center gap-3 flex-none">
                        <button onclick="editQty('${key}')" class="bg-blue-900/40 text-blue-400 border border-blue-900/50 min-w-[3rem] h-10 rounded-lg font-bold flex items-center justify-center hover:bg-blue-800/50">
                            ${item.qty}
                        </button>
                        <button onclick="deleteItem('${key}')" class="text-slate-600 hover:text-red-500 px-2 py-2">
                            <i class="fa-solid fa-times"></i>
                        </button>
                    </div>
                `;
                ui.list.appendChild(div);
            });

            ui.totalCount.innerText = keys.length;
            ui.totalQty.innerText = tQty;
        }

        // --- Actions ---
        window.deleteItem = (key) => {
            if(confirm(`Remove ${key}?`)) {
                delete inventory[key];
                saveData();
                renderList();
            }
        };

        window.editQty = (key) => {
            const newQty = prompt(`Update quantity for ${key}:`, inventory[key].qty);
            if(newQty !== null) {
                const n = parseInt(newQty);
                if (!isNaN(n) && n >= 0) {
                    if (n === 0) delete inventory[key];
                    else inventory[key].qty = n;
                    saveData();
                    renderList();
                }
            }
        };

        window.clearData = () => {
            if(confirm("Permanently delete ALL scanned data?")) {
                inventory = {};
                saveData();
                renderList();
            }
        };

        window.downloadCSV = () => {
            const keys = Object.keys(inventory);
            if (keys.length === 0) return alert("Nothing to export");

            const headers = "Code,Format,Quantity,LastScanTime\n";
            const rows = keys.map(k => {
                const i = inventory[k];
                return `"${i.code}",${i.format},${i.qty},${new Date(i.timestamp).toISOString()}`;
            }).join("\n");

            const blob = new Blob([headers + rows], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.setAttribute("href", url);
            link.setAttribute("download", `inventory_${new Date().toISOString().slice(0,10)}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // --- Manual Modal Logic ---
        ui.btnManual.onclick = () => {
            ui.manualModal.classList.remove('hidden');
            ui.manualInput.focus();
        };
        ui.btnCancelManual.onclick = () => ui.manualModal.classList.add('hidden');
        
        ui.btnConfirmManual.onclick = () => {
            const code = ui.manualInput.value.trim();
            const qty = parseInt(ui.manualQty.value);
            if(code && qty > 0) {
                addItem(code, 'MANUAL', qty);
                ui.manualInput.value = '';
                ui.manualQty.value = 1;
                ui.manualModal.classList.add('hidden');
            }
        };
    </script>
</body>
</html>
